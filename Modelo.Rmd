---
title: "Modelo"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación inicial

Inicialmente, descargamos las librerías requeridas.

```{r librerias}
pacman::p_load(astsa,
               dplyr,
               ggplot2,
               lubridate,
               MASS,
               paletteer,
               readr,
               statmod,
               tidyr)
```

Posteriormente, se cargan los datos requeridos.

```{r descarga_datos, message = FALSE}
bicicletas <- read_csv("data/bicicletas.csv")
```

Se guarda la paleta de colores utilizada para el desarrollo del proyecto.

```{r paleta_colores}
paleta_colores <- c(
  "#4B1D91",
  "#641896",
  "#84109B",
  "#9B109C",
  "#B0179C",
  "#CB2B97",
  "#E2438A",
  "#EF6276",
  "#F28265",
  "#F2A85F",
  "#EDC375",
  "#E7D39A"
)
```

Algunas correcciones de formato.

```{r formato}
# Se discretiza la variable de días de la semana
bicicletas$weekday <- as.factor(bicicletas$weekday)
levels(bicicletas$weekday) <- c("Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb")

# Se discretiza la variable del clima
bicicletas$weathersit <- as.factor(bicicletas$weathersit)
levels(bicicletas$weathersit) <- c("Despejado", "Nublado", "Lluvioso/Nevado")

# Se discretiza la variable de la estacion (para boxplot)
bicicletas$season <- as.factor(bicicletas$season)
levels(bicicletas$season) <- c("1", "2", "3", "4")
```

# Desarrollo del modelo

## Ajuste del modelo

Es esta sección de ajusta el modelo correspondiente, el cual corresponde a un GLM. 

Inicialmente, se separan los datos en aquellos de entrenamiento y aquellos de prueba.

```{r separación}
# Datos de entrenamiento, primer año y medio
training <- bicicletas[1:547, ]

# Datos de prueba, los últimos 6 meses registrados
testing <- bicicletas[548:nrow(bicicletas), ]
```

En primer lugar, hay que notar la existencia de sobredispersión, lo cual se puede comprobar en múltiples gráficos del análisis exploratorio, por lo que se usará un modelo de regresión binomial negativa.

Debido a que se puede notar una tendencia creciente, se usará el tiempo como covariable durante el ajuste. Como parece que el clima cambia el conteo de bicicletas, se agrega como covariable. Además, ya que se observa un ciclo semanal evidente en los periodogramas, se agrega el rezago como covariable.

```{r ajuste}
# Variable de conteo en formato de serie temporal
conteo <-
  ts(data = training$cnt,
     start = c(2011, 1, 1),
     frequency = 365)

# Ajuste del modelo
ajuste <-
  glm.nb(cnt ~ dteday + weathersit + stats::lag(conteo, -7), data = training)

# Resumen del ajuste
summary(ajuste)

# Ya que la fecha parece no ser significativa, se reemplaza por la estación
ajuste <-
  glm.nb(cnt ~ season + weathersit + stats::lag(conteo, -7), data = training)

# Resumen del ajuste
summary(ajuste)
```

## Diagnósticos del modelo

```{r residuos}
plot(residuals(ajuste, type = "deviance"))
```

