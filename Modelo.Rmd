---
title: "Modelo"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación inicial

Inicialmente, descargamos las librerías requeridas.

```{r librerias}
pacman::p_load(astsa,
               dplyr,
               ggplot2,
               lubridate,
               MASS,
               paletteer,
               readr,
               statmod,
               tidyr,
               tscount)
```

Posteriormente, se cargan los datos requeridos.

```{r descarga_datos, message = FALSE}
bicicletas <- read_csv("data/bicicletas.csv")
```

Se guarda la paleta de colores utilizada para el desarrollo del proyecto.

```{r paleta_colores}
paleta_colores <- c(
  "#4B1D91",
  "#641896",
  "#84109B",
  "#9B109C",
  "#B0179C",
  "#CB2B97",
  "#E2438A",
  "#EF6276",
  "#F28265",
  "#F2A85F",
  "#EDC375",
  "#E7D39A"
)
```

Algunas correcciones de formato.

```{r formato}
# Se discretiza la variable de días de la semana
bicicletas$weekday <- as.factor(bicicletas$weekday)
levels(bicicletas$weekday) <- c("Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb")

# Se discretiza la variable del clima
bicicletas$weathersit <- as.factor(bicicletas$weathersit)
levels(bicicletas$weathersit) <- c("Despejado", "Nublado", "Lluvioso/Nevado")

# Se discretiza la variable de la estacion (para boxplot)
bicicletas$season <- as.factor(bicicletas$season)
levels(bicicletas$season) <- c("1", "2", "3", "4")
```

# Desarrollo del modelo

## Ajuste del modelo

Es esta sección de ajusta el modelo correspondiente, el cual corresponde a un GLM. 

Inicialmente, se separan los datos en aquellos de entrenamiento y aquellos de prueba.

```{r separación}
# Datos de entrenamiento, primer año y medio
training <- bicicletas[1:547, ]

# Datos de prueba, los últimos 6 meses registrados
testing <- bicicletas[548:nrow(bicicletas), ]
```

En primer lugar, hay que notar la existencia de sobredispersión, lo cual se puede comprobar en múltiples gráficos del análisis exploratorio, por lo que se usará un modelo de regresión binomial negativa.

Debido a que se puede notar una tendencia creciente, se usará el tiempo como covariable durante el ajuste. Como parece que el clima cambia el conteo de bicicletas, se agrega como covariable. Además, ya que se observa un ciclo semanal evidente en los periodogramas, se agrega el rezago como covariable.

```{r ajuste}
# Variable de conteo en formato de serie temporal
conteo <-
  ts(data = training$cnt,
     start = c(2011, 1, 1),
     frequency = 365)

# Ajuste del modelo
ajuste <-
  glm.nb(cnt ~ dteday + weathersit + stats::lag(conteo, 7), data = training)

# Resumen del ajuste
summary(ajuste)

# Ya que la fecha parece no ser significativa, se reemplaza por la estación
ajuste <-
  glm.nb(cnt ~ season + weathersit + stats::lag(conteo, 7), data = training)

# Resumen del ajuste
summary(ajuste)
```

Posteriormente, se prueba el ajuste con un modelo glarma.

```{r ajuste_glarma}
# Variable objetivo con lag semanal
training <- training %>%
  mutate(lag7 = dplyr::lag(cnt, 7)) %>%
  drop_na()

# Matriz modelo
matrizm <- model.matrix( ~ season + lag7, data = training)

# Ajuste glarma
ajuste_prueba <- tsglm(
  training$cnt,
  model = list(past_obs = 1, past_mean = 1),
  xreg = matrizm[, -1],
  distr = "nbinom",
  link = "log"
)
```


## Diagnósticos del ajuste por GLM

### Residuos

Inicialmente, se muestran los residuos de devianza.

```{r residuos}
# Se guardan los residuos de devianza
dev_res <- residuals(ajuste, type = "deviance")

# Se muestran los residuos de devianza
plot(dev_res)

# Se identifican los residuos mayores a 2 (en valor absoluto)
resid_grandes <- sort(abs(dev_res), decreasing = TRUE)[1:sum(abs(dev_res) > 2)]

# Observaciones con grandes residuos
resid_grandes <- training[names(resid_grandes), ]
```

Con respecto a los residuales grandes en valor absoluto, parece que estos son debido a eventos atípicos. Algunos ejemplos de esto:

* 19-5-2012: [Survive DC](http://www.survivedc.com), una carrera organizada en donde múltiples persona sparticipan por premios, causó más alquileres de lo normal.
* 23-3-2012: [Festival](https://link.springer.com/article/10.1007/s13748-013-0040-3) nacional de los cerezos en flor, causó más alquileres de lo normal.
* 2-6-2012: Hubo un [tornado](https://link.springer.com/article/10.1007/s13748-013-0040-3) el día anterior, lo cual causó más alquileres de lo normal.
* 26-1-2011 y 27-1-2011: Una fuerte [tormenta de nieve](https://www.washingtontimes.com/news/2011/jan/27/snowstorm-leaves-dc-area-feeling-powerless) afectó diversas áreas de EEUU, incluyendo el área de Washington, en donde se ubica el sistema de bicicletas, lo cual causó menos alquileres de lo normal.
* 6-3-2011: Fue de los días de más humedad registrada, lo cual coincidió con un clima nublado en domingo, lo cual redujo las bicicletas alquiladas, a pesar de ser un día de fin de semana.
* 24-12-2011 y 25-12-2011: Nochebuena y Navidad, lo cual parece haber reducido la cantidad de bicicletas alquiladas.

Posteriormente, los residuales contra cada una de las variables numéricas utilizadas.

```{r linealidad_modelo}
# scatter.smooth(rstandard(ajuste) ~ stats::lag(conteo, -7), col="grey", las=1, ylab="Standardized residuals", xlab="Height (inches)")

# termplot(ajuste, partial.resid = TRUE, terms = "stats::lag(conteo, -7)", las=1)

# scatter.smooth(rstandard(ajuste) ~ fitted(ajuste), col="grey", las=1, ylab="Standardized residuals", xlab="Fitted values")

# Se guardan los residuales
r <- rstandard(ajuste)

# Lagplot
plot(
  r[-length(r)],
  r[-1],
  xlab = "Residual en t-1",
  ylab = "Residual en t",
  main = "Lag Plot",
  pch = 19,
  col = paleta_colores[1]
)
```


### Apalancamientos

Seguidamente, se muestran algunos de los apalancamientos más grandes.

```{r apalancamientos}
# Se guardan los apalancamientos
apalancamientos <- hatvalues(ajuste)

# Se identifican las apalancamientos mayores al doble de la media
apal_grandes <-
  sort(apalancamientos, decreasing = TRUE)[1:sum(apalancamientos > 2 * mean(apalancamientos))]

# Observaciones con grandes apalancamientos
apal_grandes <- training[names(apal_grandes), ]

# Se grafica el clima de las observaciones con grandes apalancamientos
data.frame(
  "clima" = names(table(training$weathersit, exclude = "Despejado")),
  "entrenamiento" = as.numeric(table(training$weathersit, exclude = "Despejado")),
  "influyentes" = as.numeric(table(apal_grandes$weathersit, exclude = "Despejado"))
) %>%
  pivot_longer(
    cols = c(entrenamiento, influyentes),
    names_to = "nombre",
    values_to = "valor"
  ) %>%
  ggplot(aes(x = clima, y = valor, fill = nombre)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Clima",
       y = "Cantidad de observaciones",
       fill = "") +
  theme_minimal() +
  scale_fill_manual(
    values = c(paleta_colores[2], paleta_colores[7]),
    labels = c("media" = "Media del conteo",
               "varianza" = "Varianza del conteo (en miles)")
  )
```

La observación restante es:

```{r obs_apal}
# El otro gran apalancamiento que no cumple lo del clima
apal_grandes[18, "dteday"]
```

Esta fecha corresponde al día de San Patricio del año 2012, la cual coincidió con la presencia del presidente estadounidense Barack Obama en [Washington](https://www.shutterstock.com/es/editorial/image-editorial/s-president-barack-obama-toasts-guinness-beer-12359379e) (lugar del negocio de bicicletas). Además, hay reportes de que los cerezos de una zona de Washington estaban en plena [floración](https://www.shutterstock.com/es/image-photo/washington-dc-march-17-cherry-trees-166299320). 

Parece que los 3 eventos juntos causaron un aumento atípico en la cantidad de bicicletas alquiladas ese día, lo cual explica su alto apalancamiento.

### ACF y PACF de residuos

Posteriormente, se muestra el ACF y PACF de los residuos resultantes del modelo GLM binomial negativo.

```{r acf_residuos}
acf2(residuals(ajuste, type = "deviance"), 100)
```

## Diagnósticos del ajuste por glarma

Se muestran los residuos de Pearson.

```{r residuos_glarma}
plot(residuals(ajuste_prueba, type = "pearson"))
```

Adicionalmente, el ACF y PACF de los residuos restantes.

```{r acfs_glarma}
acf2(residuals(ajuste_prueba, type = "pearson"), 100)
```

