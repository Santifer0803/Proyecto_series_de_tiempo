---
title: "Analisis_exploratorio"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación inicial

Inicialmente, descargamos las librerías requeridas.

```{r librerias}
pacman::p_load(astsa,
               dplyr,
               ggplot2,
               lubridate,
               paletteer,
               readr,
               tidyr)
```

Posteriormente, se cargan los datos requeridos.

```{r descarga_datos, message = FALSE}
bicicletas <- read_csv("data/bicicletas.csv")
```

Se guarda la paleta de colores utilizada para el desarrollo del proyecto.

```{r paleta_colores}
paleta_colores <- c(
  "#4B1D91",
  "#641896",
  "#84109B",
  "#9B109C",
  "#B0179C",
  "#CB2B97",
  "#E2438A",
  "#EF6276",
  "#F28265",
  "#F2A85F",
  "#EDC375",
  "#E7D39A"
)
```

Algunas correcciones de formato.

```{r formato}
# Se discretiza la variable de días de la semana
bicicletas$weekday <- as.factor(bicicletas$weekday)
levels(bicicletas$weekday) <- c("Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb")

# Se discretiza la variable del clima
bicicletas$weathersit <- as.factor(bicicletas$weathersit)
levels(bicicletas$weathersit) <- c("Despejado", "Nublado", "Lluvioso/Nevado")

# Se discretiza la variable de la estacion (para boxplot)
bicicletas$season <- as.factor(bicicletas$season)
levels(bicicletas$season) <- c("Invierno", "Primavera", "Verano", "Otoño")

# Factor para día festivo (0/1 -> No festivo / Festivo)
bicicletas$holiday <- as.factor(bicicletas$holiday)
levels(bicicletas$holiday) <- c("No festivo", "Festivo")

# Factor para día laboral (0/1 -> No laboral / Laboral)
bicicletas$workingday <- as.factor(bicicletas$workingday)
levels(bicicletas$workingday) <- c("No laboral", "Laboral")

# Factor para año (0/1 -> 2011 / 2012)
bicicletas$yr <- as.factor(bicicletas$yr)
levels(bicicletas$yr) <- c("2011", "2012")
```

# Análisis exploratorio de datos

A través de diversas herramientas, se busca entender el contenido de los datos. Con esto, se pueden evidenciar variables relevantes e interacciones entre los diversos factores de la información disponible.

## Boxplots

En este caso, se analiza el comportamiento de algunas variables a través de boxplots, con la intención de detectar patrones relevantes en las variables de forma individual y al interactuar con otras variables.

```{r boxplots}
# Conteo de bicicletas según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = cnt, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = casual, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = registered, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas según el clima
ggplot(bicicletas,
       aes(x = weathersit, y = cnt, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según el clima
ggplot(bicicletas,
       aes(x = weathersit, y = casual, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según el clima
ggplot(bicicletas,
       aes(x = weathersit, y = registered, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas (total) según estación
ggplot(bicicletas,
       aes(x = season, y = cnt, fill = season)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según estación
ggplot(bicicletas,
       aes(x = season, y = casual, fill = season)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según estación
ggplot(bicicletas,
       aes(x = season, y = registered, fill = season)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas (total) según año
ggplot(bicicletas,
       aes(x = yr, y = cnt, fill = yr)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según año
ggplot(bicicletas,
       aes(x = yr, y = casual, fill = yr)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según año
ggplot(bicicletas,
       aes(x = yr, y = registered, fill = yr)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```

## Boxplot por día festivo

Para esta sección se agregan boxplots de las variables contra los días festivos, con el fin de observar la distribución de los alquileres en estas fechas.

```{r alquileres_totales_por_días_festivos}
ggplot(bicicletas,
       aes(x = holiday, y = cnt, fill = holiday)) +
  geom_boxplot() +
  labs(x = "Día festivo", y = "Alquileres totales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```
En el gráfico anterior se puede observar una mayor dispersión de los días festivos, y un menor promedio de alquileres en contraste de los días no festivos, donde el promedio es mayor y de hecho hay una menor distribución de los datos, indicando de cierta forma una consistencia en los datos. 

```{r alquileres_casuales_por_día_festivo}
ggplot(bicicletas,
       aes(x = holiday, y = casual, fill = holiday)) +
  geom_boxplot() +
  labs(x = "Día festivo", y = "Alquileres casuales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```
Del boxplot anterior se observa entonces que la diferencia entre promedios casi no es significativa, por un lado, por el otro, se observa una mayor dispersión de los datos cuando el día festivo. Además se observan bastantes outliers cuando el día no es festivo. 


```{r alquileres_regulares_por_día_festivo}
ggplot(bicicletas,
       aes(x = holiday, y = registered, fill = holiday)) +
  geom_boxplot() +
  labs(x = "Día festivo", y = "Alquileres registrados") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```
Del gráfico anterior, se observa entonces un comportamiento el cual es esperado, debido a que los días no festivos, la cantidad de alquileres registrados debería tener un promedio alto, en comparación a los días festivos

## Boxplot por día trabajado

Para esta sección se crea la variable indicadora, con el fin de filtrar las observaciones y realizar el cálculo del promedio mediante visualización de cajas:

```{r alquileres_totales_por_día_laboral}
ggplot(bicicletas,
       aes(x = workingday, y = cnt, fill = workingday)) +
  geom_boxplot() +
  labs(x = "Día laboral", y = "Alquileres totales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```
Del gráfico anterior se observa una mayor cantidad alquileres en los días no laborales, sin embargo, el promedio de alquileres de ambos días tienen un comportamiento parecido. 


```{r Alquileres_casuales_por_día_laboral}
ggplot(bicicletas,
       aes(x = workingday, y = casual, fill = workingday)) +
  geom_boxplot() +
  labs(x = "Día laboral", y = "Alquileres casuales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```
Gracias a este boxplot se puede hacer la diferencia de las personas que alquilan de manera casual, en donde se puede observar la diferencia que existe entre el promedio de alquileres en los días no laborales a los días que sí son laborales. Esto tiene sentido, pues las personas que alquilan de manera no casual lo hacen a modo recreativo los días que no son laborales. 

```{r alquileres_regulares_por_día_laboral}
ggplot(bicicletas,
       aes(x = workingday, y = registered, fill = workingday)) +
  geom_boxplot() +
  labs(x = "Día laboral", y = "Alquileres registrados") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```

Por otro lado, con el botplox anterior, se puede observar como las personas que usan la app con frecuencia, de hecho tienen mayor constancia los días que son laborales. Esto puede indicar varias razones, por ejemplo que utilicen el alquiler como medio de transporte, por ende hay una disminución del alquiler en días no laborales, ya que las personas no van al trabajo. Otra posible explicación se puede deber a que estas personas utilizan la bicicleta como parte de sus rutina de ejercicios los días laborales y descansan los días no laborales. 

## Boxplots por año

Debido a la tendencia creciente de las series de tiempo, separar los alquileres por año podría suponer una discriminación correcta de los datos de bicicletas. Esta se muestra a continuación.

```{r totales_anno}
ggplot(bicicletas,
       aes(x = yr, y = cnt, fill = yr)) +
  geom_boxplot() +
  labs(x = "Año", y = "Alquileres totales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```

Luego, se separa con los alquileres de usuarios casuales.

```{r casuales_anno}
ggplot(bicicletas,
       aes(x = yr, y = casual, fill = yr)) +
  geom_boxplot() +
  labs(x = "Año", y = "Alquileres casuales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```

Finalmente, se procede con los alquileres de usuarios registrados.

```{r registrados_anno}
ggplot(bicicletas,
       aes(x = yr, y = registered, fill = yr)) +
  geom_boxplot() +
  labs(x = "Año", y = "Alquileres registrados") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```


## Boxplots continuos

Se procede con los boxplots de las variables continuas que presentan los datos.

```{r boxplots_continuos}
variables_cont <- c("temp", "atemp", "hum", "windspeed")

for (i in variables_cont) {
  print(
    ggplot(bicicletas, aes(x = "", y = .data[[i]], fill = i)) +
      geom_boxplot() +
      labs(title = paste("Distribución de", i),
           x = NULL, y = "Valor") +
      theme_minimal() +
      theme(legend.position = "none") +
      scale_fill_manual(values = paleta_colores)
  )
}
```

## Series de tiempo

Se grafican las series de tiempo de las variables coherentes: no se grafican ni variables categóricas ni variables redundantes como el día de la semana.  

```{r series_de_tiempo}
# Temperatura
ggplot(bicicletas, aes(x = dteday, y = temp)) +
  geom_line(color = paleta_colores[1], linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, color = paleta_colores[7], linewidth = 1.2) +
  labs(x = "Fecha", y = "Temperatura") +
  theme_minimal()

# Temperatura percibida
ggplot(bicicletas, aes(x = dteday, y = atemp)) +
  geom_line(color = paleta_colores[2], linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, color = paleta_colores[8], linewidth = 1.2) +
  labs(x = "Fecha", y = "Temperatura percibida") +
  theme_minimal()

# Humedad
ggplot(bicicletas, aes(x = dteday, y = hum)) +
  geom_line(color = paleta_colores[3], linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, color = paleta_colores[9], linewidth = 1.2) +
  labs(x = "Fecha", y = "Humedad") +
  theme_minimal()

# Velocidad del viento
ggplot(bicicletas, aes(x = dteday, y = windspeed)) +
  geom_line(color = paleta_colores[4], linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, color = paleta_colores[10], linewidth = 1.2) +
  labs(x = "Fecha", y = "Velocidad del viento") +
  theme_minimal()

# Casual y registererd
ggplot() +
  # Línea 1: casuales
  geom_line(data = bicicletas, aes(x = dteday, y = casual, color = "Alquileres casuales"), linewidth = 1) +
  geom_smooth(data = bicicletas, aes(x = dteday, y = casual),
              method = "lm", se = FALSE, color = "black", linewidth = 1.8, linetype = "dashed") +
  
  # Línea 2: registrados
  geom_line(data = bicicletas, aes(x = dteday, y = registered, color = "Alquileres registrados"), linewidth = 1) +
  geom_smooth(data = bicicletas, aes(x = dteday, y = registered),
              method = "lm", se = FALSE, color = "black", linewidth = 1.8, linetype = "dashed") +

  # Colores personalizados desde la paleta
  scale_color_manual(values = c(
    "Alquileres casuales" = paleta_colores[3],
    "Alquileres registrados" = paleta_colores[6]
  )) +
  
  labs(x = "Fecha", y = "Cantidad", color = "Variable") +
  theme_minimal()


# Alquileres totales
ggplot(bicicletas, aes(x = dteday, y = cnt)) +
  geom_line(color = paleta_colores[1], linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, color = paleta_colores[7], linewidth = 1.2) +
  labs(x = "Fecha", y = "Bicicletas alquiladas") +
  theme_minimal()
```

## ACF

Para esta sección se calculan las respectivas ACF de cada variable, tomando un lag de un mes para su visualización y posible interpretación:

```{r acf_temp}
acf(bicicletas$temp, lag.max = 100, main = "")
```

Como los datos son diarios, entonces se toma un rezago de 31 días, con el fin de simular un mes de lag. Seguidamente, se debe observar que hay una fuerte correlación y además, esta es significativa. Esto sugiere que la temperatura de hoy está fuertemente relacionada a la temperatura de ayer, lo cual tiene sentido, pues las temperaturas tienden a mantenerse constantes en una misma estación del año. Se nota además un comportamiento persistente, no hay oscilaciones. 

Analizando por otro lado la temperatura percibida:

```{r acf_atemp}
acf(bicicletas$atemp, lag.max = 100, main = "")
```

No se observa un cambio significativo en relación de la variable anterior, lo que sugiere el mismo patrón de análisis.

```{r acf_hum}
acf(bicicletas$hum, lag.max = 100, main = "")
```

Del gráfico anterior se puede inferir entonces que la variable humedad no tiene una memoria de largo plazo, pues al cabo de 2 o 3 días hay un rápido decaimiento del ACF, lo que indica que la humedad de hoy depende hasta cierto punto de la variable de ayer. Sin embargo, las condiciones de humedad sí pueden cambiar de manera significativa con respecto a los días. 

```{r acf_windspeed}
acf(bicicletas$windspeed, lag.max = 100, main = "")
```

Note que en relación a la variable Velocidad del Viento se comporta de manera similar a la humedad, lo que sugiere un comportamiento de memoria corta, es decir, que no hay tanta relación de la velocidad del viento hoy con la velocidad del viento de ayer. 

```{r acf_casual}
acf(bicicletas$casual, lag.max = 100, main = "")
```

La variable de alquileres casuales es de sumo interés, pues hay una regularidad en el patrón, lo que sugiere que las personas tienden a alquilar más la bicicletas cada cierto tiempo. Esto tiene sentido, pues las personas que alquilan bicicletas de manera casual lo harán con mayor probabilidad los fines de semana, implicando de esta forma que existe una estacionalidad semanal, es decir, un comportamiento similar a través del tiempo. 

Por último se analiza la variable de alquileres totales: 

```{r acf_cnt}
acf(bicicletas$cnt, lag.max = 100, main = "")
```

Note que es un proceso de memoria larga, es decir, que la cantidad de bicicletas totales que se alquilaron hoy dependen fuertemente de la cantidad de bicicletas que se alquilaron el día de ayer. 

Para las variables que presentaron mucha correlación se aplica la primer diferencia, con tal de observar el comportamiento: 

```{r acf_diff_temp}
acf(diff(bicicletas$temp), lag.max = 100, main = "")
```

Se observa entonces una disminución en la correlación existente. Se aplica el mismo razonamiento a las otras variables: 

```{r acf_diff_atemp}
acf(diff(bicicletas$atemp), lag.max = 100, main = "")
```

Al aplicar la primer diferencia se elimina el comportamiento persistente, lo que sugiere que las diferencias siguen un comportamiento cíclico y unas correlaciones bajas.

```{r acf_diff_cnt}
acf(diff(bicicletas$cnt), lag.max = 100, main = "")
```

La correlación negativa indica que el número de bicicletas de hoy afecta de manera inversa al alquiler de bicicleta del día de mañana. Se logra eliminar la tendencia gracias a la diferenciación y se elimina la memoria temporal fuerte existente.

Finalmente, se agrega el ACF junto al PACF de la variable objetivo.

```{r acf_pacf_cnt}
acf2(bicicletas$cnt, 100, main = "")
```

Se observa una función de autocorrelación con significancia en rezagos muy elevados, decreciendo de forma muy lenta, al igual que un PACF con valores significativos en rezagos avanzados.

## CCF

Seguidamente se calculan las CCF de la variable conteo con el resto de las variables, tomando igualmente un lag de un mes para su visualización y posible interpretación.

```{r CCFs}
# CCF entre el conteo total y la velocidad del viento
ccf(bicicletas$cnt, bicicletas$windspeed, lag.max = 31, main = "", ylab = "CCF")

# CCF entre el conteo total y la humedad
ccf(bicicletas$cnt, bicicletas$hum, lag.max = 31, main = "", ylab = "CCF")

# CCF entre el conteo total y la sensación térmica
ccf(bicicletas$cnt, bicicletas$atemp, lag.max = 31, main = "", ylab = "CCF")

# CCF entre el conteo total y la temperatura
ccf(bicicletas$cnt, bicicletas$temp, lag.max = 31, main = "", ylab = "CCF")
```

## Coherencia

En este sección se visualizan las coherencias cuadradads entre la variable de conteo y diversas variable coherentes, con el fin de medir la intensidad de la relación lineal entre las dos series en cada frecuencia.

```{r coherencias}
# Se calcula el espectro cruzado del conteo y la velocidad del viento
cnt_ws <- mvspec(
  cbind(
    ts(
      bicicletas$cnt,
      start = c(2011, 1, 1),
      frequency = 365
    ),
    ts(
      bicicletas$windspeed,
      start = c(2011, 1, 1),
      frequency = 365
    )),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  main = "",
  plot = FALSE
)

# Valor crítico para un nivel de significancia de 95%
C <- qf(.95, 2, cnt_ws$df - 2) / (((cnt_ws$df/2) - 1) + qf(.95, 2, cnt_ws$df - 2))

plot(cnt_ws, plot.type = "coh", ci.lty = 2, xlab = "Frecuencia (diaria)", 
     ylab = "Coherencia cuadrada", main = "", col = paleta_colores[3])
abline(h = C, col = paleta_colores[5])

# Se calcula el espectro cruzado del conteo y la humedad
cnt_hum <- mvspec(
  cbind(
    ts(
      bicicletas$cnt,
      start = c(2011, 1, 1),
      frequency = 365
    ),
    ts(
      bicicletas$hum,
      start = c(2011, 1, 1),
      frequency = 365
    )),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  main = "",
  plot = FALSE
)

# Valor crítico para un nivel de significancia de 95%
C <- qf(.95, 2, cnt_hum$df - 2) / (((cnt_hum$df/2) - 1) + qf(.95, 2, cnt_hum$df - 2))

plot(cnt_hum, plot.type = "coh", ci.lty = 2, xlab = "Frecuencia (diaria)", 
     ylab = "Coherencia cuadrada", main = "", col = paleta_colores[3])
abline(h = C, col = paleta_colores[5])

# Se calcula el espectro cruzado del conteo y la sensación térmica
cnt_atemp <- mvspec(
  cbind(
    ts(
      bicicletas$cnt,
      start = c(2011, 1, 1),
      frequency = 365
    ),
    ts(
      bicicletas$atemp,
      start = c(2011, 1, 1),
      frequency = 365
    )),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  main = "",
  plot = FALSE
)

# Valor crítico para un nivel de significancia de 95%
C <- qf(.95, 2, cnt_atemp$df - 2) / (((cnt_atemp$df/2) - 1) + qf(.95, 2, cnt_atemp$df - 2))

plot(cnt_atemp, plot.type = "coh", ci.lty = 2, xlab = "Frecuencia (diaria)", 
     ylab = "Coherencia cuadrada", main = "", col = paleta_colores[3])
abline(h = C, col = paleta_colores[5])

# Se calcula el espectro cruzado del conteo y la temperatura
cnt_temp <- mvspec(
  cbind(
    ts(
      bicicletas$cnt,
      start = c(2011, 1, 1),
      frequency = 365
    ),
    ts(
      bicicletas$temp,
      start = c(2011, 1, 1),
      frequency = 365
    )),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  main = "",
  plot = FALSE
)

# Valor crítico para un nivel de significancia de 95%
C <- qf(.95, 2, cnt_temp$df - 2) / (((cnt_temp$df/2) - 1) + qf(.95, 2, cnt_temp$df - 2))

# Se grafica la coherencia cuadrada
plot(cnt_temp, plot.type = "coh", ci.lty = 2, xlab = "Frecuencia (diaria)", 
     ylab = "Coherencia cuadrada", main = "", col = paleta_colores[3])
abline(h = C, col = paleta_colores[5])
```

## Sobredispersión

Ahora se calculará la media y la varianza de la variable conteo separando por distintas variables categóricas, con el fin de determinar si los datos presentan sobredispersión.

```{r media_varianza}
# Media y varianza separando por clima
medvar_wts <- bicicletas %>%
  group_by(weathersit) %>%
  summarise(media = mean(cnt),
            varianza = var(cnt) / 1000) %>%
  pivot_longer(cols = c(media, varianza),
               names_to = "tipo",
               values_to = "valor")

# Gráfico de la media y varianza por clima
ggplot(medvar_wts, aes(x = weathersit, y = valor, fill = tipo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Clima",
       y = "Valor",
       fill = "") +
  theme_minimal() +
  scale_fill_manual(values = c(paleta_colores[2], paleta_colores[7]),
                    labels = c("media" = "Media del conteo",
                             "varianza" = "Varianza del conteo (en miles)"))

# Media y varianza separando por día laboral
medvar_wkd <- bicicletas %>%
  group_by(workingday) %>%
  summarise(media = mean(cnt),
            varianza = var(cnt) / 1000) %>%
  pivot_longer(cols = c(media, varianza),
               names_to = "tipo",
               values_to = "valor")

# Gráfico de la media y varianza por día laboral
ggplot(medvar_wkd, aes(x = factor(workingday), y = valor, fill = tipo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Día laboral",
       y = "Valor",
       fill = "") +
  theme_minimal() +
  scale_fill_manual(values = c(paleta_colores[2], paleta_colores[7]),
                    labels = c("media" = "Media del conteo",
                             "varianza" = "Varianza del conteo (en miles)"))

# Media y varianza separando por día de la semana
medvar_wd <- bicicletas %>%
  group_by(weekday) %>%
  summarise(media = mean(cnt),
            varianza = var(cnt) / 1000) %>%
  pivot_longer(cols = c(media, varianza),
               names_to = "tipo",
               values_to = "valor")

# Gráfico de la media y varianza por día de la semana
ggplot(medvar_wd, aes(x = weekday, y = valor, fill = tipo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Día de la semana",
       y = "Valor",
       fill = "") +
  theme_minimal() +
  scale_fill_manual(values = c(paleta_colores[2], paleta_colores[7]),
                    labels = c("media" = "Media del conteo",
                             "varianza" = "Varianza del conteo (en miles)"))

# Media y varianza separando por día festivo
medvar_hd <- bicicletas %>%
  group_by(holiday) %>%
  summarise(media = mean(cnt),
            varianza = var(cnt) / 1000) %>%
  pivot_longer(cols = c(media, varianza),
               names_to = "tipo",
               values_to = "valor")

# Gráfico de la media y varianza por día de festivo
ggplot(medvar_hd, aes(x = factor(holiday), y = valor, fill = tipo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Día festivo",
       y = "Valor",
       fill = "") +
  theme_minimal() +
  scale_fill_manual(values = c(paleta_colores[2], paleta_colores[7]),
                    labels = c("media" = "Media del conteo",
                             "varianza" = "Varianza del conteo (en miles)"))

# Media y varianza separando por estación
medvar_ssn <- bicicletas %>%
  group_by(season) %>%
  summarise(media = mean(cnt),
            varianza = var(cnt) / 1000) %>%
  pivot_longer(cols = c(media, varianza),
               names_to = "tipo",
               values_to = "valor")

# Gráfico de la media y varianza por estación
ggplot(medvar_ssn, aes(x = season, y = valor, fill = tipo)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Estación",
       y = "Valor",
       fill = "") +
  theme_minimal() +
  scale_fill_manual(values = c(paleta_colores[2], paleta_colores[7]),
                    labels = c("media" = "Media del conteo",
                             "varianza" = "Varianza del conteo (en miles)"))
```

## Periodogramas

Para hacer un análisis de las frecuencias que pueden existir en las diversas variables, se procede con algunos periodogramas.

```{r periodogramas}
# Se grafica el periodograma del conteo de la temperatura
temp_bicis <- mvspec(
  ts(
    bicicletas$temp,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = temp_bicis$freq,
           spec = temp_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la sensación térmica
atemp_bicis <- mvspec(
  ts(
    bicicletas$atemp,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = atemp_bicis$freq,
           spec = atemp_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la humedad
hum_bicis <- mvspec(
  ts(
    bicicletas$hum,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = hum_bicis$freq,
           spec = hum_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la velocidad del viento
viento_bicis <- mvspec(
  ts(
    bicicletas$windspeed,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = viento_bicis$freq,
           spec = viento_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas
conteo_bicis <- mvspec(
  ts(
    bicicletas$cnt,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = conteo_bicis$freq,
           spec = conteo_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas casuales
casual_bicis <- mvspec(
  ts(
    bicicletas$casual,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = casual_bicis$freq,
           spec = casual_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  geom_vline(
    xintercept = 52,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    xintercept = 104,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "text",
    x = 52,
    y = 22500,
    label = "Frecuencia = 52",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  annotate(
    "text",
    x = 104,
    y = 6000,
    label = "Frecuencia = 104",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  labs(x = "Frecuencia (x 365)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas registradas
registro_bicis <- mvspec(
  ts(
    bicicletas$registered,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = registro_bicis$freq,
           spec = registro_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  geom_vline(
    xintercept = 52,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    xintercept = 104,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "text",
    x = 52,
    y = 30000,
    label = "Frecuencia = 52",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  annotate(
    "text",
    x = 104,
    y = 6000,
    label = "Frecuencia = 104",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  labs(x = "Frecuencia (x 365)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)
```
