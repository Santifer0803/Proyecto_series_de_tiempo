---
title: "Analisis_exploratorio"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación inicial

Inicialmente, descargamos las librarías requeridas.

```{r librarias}
pacman::p_load(astsa,
               dplyr,
               ggplot2,
               lubridate,
               paletteer,
               readr)
```

Posteriormente, se cargan los datos requeridos.

```{r descarga_datos, message = FALSE}
bicicletas <- read_csv("data/bicicletas.csv")
```

Se guarda la paleta de colores utilizada para el desarrollo del proyecto.

```{r paleta_colores}
paleta_colores <- c(
  "#4B1D91",
  "#641896",
  "#84109B",
  "#9B109C",
  "#B0179C",
  "#CB2B97",
  "#E2438A",
  "#EF6276",
  "#F28265",
  "#F2A85F",
  "#EDC375",
  "#E7D39A"
)
```

Algunas correcciones de formato.

```{r formato}
# Se discretiza la variable de días de la semana
bicicletas$weekday <- as.factor(bicicletas$weekday)
levels(bicicletas$weekday) <- c("Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb")

# Se discretiza la variable del clima
bicicletas$weathersit <- as.factor(bicicletas$weathersit)
levels(bicicletas$weathersit) <- c("Despejado", "Nublado", "Lluvioso/Nevado")
```


# Análisis exploratorio de datos

A través de diversas herramientas, se busca entender el contenido de los datos. Con esto, se pueden evidenciar variables relevantes e interacciones entre los diversos factores de la información disponible.

## Boxplots

En este caso, se analiza el comportamiento de algunas variables a través de boxplots, con la intención de detectar patrones relevantes en las variables de forma individual y al interactuar con otras variables.

```{r boxplots}
# Conteo de bicicletas según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = cnt, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = casual, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = registered, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas según día de la semana
ggplot(bicicletas,
       aes(x = weathersit, y = cnt, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según día de la semana
ggplot(bicicletas,
       aes(x = weathersit, y = casual, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según día de la semana
ggplot(bicicletas,
       aes(x = weathersit, y = registered, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```


## Series de tiempo

Se grafica las series de tiempo de las variables coherentes: no se grafican ni variables categoricas ni variables redundantes como el dia de la semana.  

```{r series_de_tiempo}
#Temperatura
ggplot(bicicletas, aes(x = dteday, y = temp)) +
  geom_line(color = paleta_colores[1], linewidth = 1) +
  labs(x = "Fecha", y = "Temperatura") +
  theme_minimal()

#Temperatura percibida
ggplot(bicicletas, aes(x = dteday, y = atemp)) +
  geom_line(color = paleta_colores[3], linewidth = 1) +
  labs(x = "Fecha", y = "Sensación de temperatura") +
  theme_minimal()

#Humedad
ggplot(bicicletas, aes(x = dteday, y = hum)) +
  geom_line(color = paleta_colores[5], linewidth = 1) +
  labs(x = "Fecha", y = "Humedad") +
  theme_minimal()

#Velocidad del viento
ggplot(bicicletas, aes(x = dteday, y = windspeed)) +
  geom_line(color = paleta_colores[7], linewidth = 1) +
  labs(x = "Fecha", y = "Velocidad del viento") +
  theme_minimal()

#Casual y registererd
ggplot() +
  geom_line(data = bicicletas, aes(x = dteday, y = casual, color = "Alquileres casuales"), linewidth = 1) +
  geom_line(data = bicicletas, aes(x = dteday, y = registered, color = "Alquileres registrados"), linewidth = 1) +
  scale_color_manual(values = c("Alquileres casuales" = paleta_colores[8],
                                "Alquileres registrados" = paleta_colores[11])) +
  labs(x = "Fecha", y = "Cantidad",
       color = "Variable") +
  theme_minimal()

#Alquileres totales
ggplot(bicicletas, aes(x = dteday, y = cnt)) +
  geom_line(color = paleta_colores[2], linewidth = 1) +
  labs(x = "Fecha", y = "Bicicletas alquiladas") +
  theme_minimal()
```


## ACF

A

## CCF

A

## Coherencia

A

## Sobredispersión

A

## Periodogramas

Para hacer un análisis de las frecuencias que pueden existir en las diversas variables, se procede con algunos periodogramas.

```{r periodogramas}
# Se grafica el periodograma del conteo de la temperatura
temp_bicis <- mvspec(
  ts(
    bicicletas$temp,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = temp_bicis$freq,
           spec = temp_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la sensación térmica
atemp_bicis <- mvspec(
  ts(
    bicicletas$atemp,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = atemp_bicis$freq,
           spec = atemp_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la humedad
hum_bicis <- mvspec(
  ts(
    bicicletas$hum,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = hum_bicis$freq,
           spec = hum_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la velocidad del viento
viento_bicis <- mvspec(
  ts(
    bicicletas$windspeed,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = viento_bicis$freq,
           spec = viento_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas
conteo_bicis <- mvspec(
  ts(
    bicicletas$cnt,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = conteo_bicis$freq,
           spec = conteo_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas casuales
casual_bicis <- mvspec(
  ts(
    bicicletas$casual,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = casual_bicis$freq,
           spec = casual_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  geom_vline(
    xintercept = 52,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    xintercept = 104,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "text",
    x = 52,
    y = 22500,
    label = "Frecuencia = 52",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  annotate(
    "text",
    x = 104,
    y = 6000,
    label = "Frecuencia = 104",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas registradas
registro_bicis <- mvspec(
  ts(
    bicicletas$registered,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = registro_bicis$freq,
           spec = registro_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  geom_vline(
    xintercept = 52,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    xintercept = 104,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "text",
    x = 52,
    y = 30000,
    label = "Frecuencia = 52",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  annotate(
    "text",
    x = 104,
    y = 6000,
    label = "Frecuencia = 104",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)
```
