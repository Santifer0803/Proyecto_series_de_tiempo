---
title: "Analisis_exploratorio"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación inicial

Inicialmente, descargamos las librarías requeridas.

```{r librarias}
pacman::p_load(astsa,
               dplyr,
               ggplot2,
               lubridate,
               paletteer,
               readr)
```

Posteriormente, se cargan los datos requeridos.

```{r descarga_datos, message = FALSE}
bicicletas <- read_csv("data/bicicletas.csv")
```

Se guarda la paleta de colores utilizada para el desarrollo del proyecto.

```{r paleta_colores}
paleta_colores <- c(
  "#4B1D91",
  "#641896",
  "#84109B",
  "#9B109C",
  "#B0179C",
  "#CB2B97",
  "#E2438A",
  "#EF6276",
  "#F28265",
  "#F2A85F",
  "#EDC375",
  "#E7D39A"
)
```

Algunas correcciones de formato.

```{r formato}
# Se discretiza la variable de días de la semana
bicicletas$weekday <- as.factor(bicicletas$weekday)
levels(bicicletas$weekday) <- c("Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb")

# Se discretiza la variable del clima
bicicletas$weathersit <- as.factor(bicicletas$weathersit)
levels(bicicletas$weathersit) <- c("Despejado", "Nublado", "Lluvioso/Nevado")

# Se discretiza la variable de la estacion (para boxplot)
bicicletas$season <- as.factor(bicicletas$season)
levels(bicicletas$season) <- c("1", "2", "3", "4")
```


# Análisis exploratorio de datos

A través de diversas herramientas, se busca entender el contenido de los datos. Con esto, se pueden evidenciar variables relevantes e interacciones entre los diversos factores de la información disponible.

## Boxplots

En este caso, se analiza el comportamiento de algunas variables a través de boxplots, con la intención de detectar patrones relevantes en las variables de forma individual y al interactuar con otras variables.

```{r boxplots}
# Conteo de bicicletas según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = cnt, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = casual, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según día de la semana
ggplot(bicicletas,
       aes(x = weekday, y = registered, fill = weekday)) +
  geom_boxplot() +
  labs(x = "Día de la semana", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas según día de la semana
ggplot(bicicletas,
       aes(x = weathersit, y = cnt, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según día de la semana
ggplot(bicicletas,
       aes(x = weathersit, y = casual, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según día de la semana
ggplot(bicicletas,
       aes(x = weathersit, y = registered, fill = weathersit)) +
  geom_boxplot() +
  labs(x = "Clima", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas (total) según estacion
ggplot(bicicletas,
       aes(x = season, y = cnt, fill = season)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas casuales según estacion
ggplot(bicicletas,
       aes(x = season, y = casual, fill = season)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Conteo de bicicletas registradas según estacion
ggplot(bicicletas,
       aes(x = season, y = registered, fill = season)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Cantidad de bibicletas") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)
```

## Boxplot por día festivo:

(Agregar INFO)

```{r}
# Factor para día festivo (0/1 -> No festivo / Festivo)
bicicletas$holiday <- as.factor(bicicletas$holiday)
levels(bicicletas$holiday) <- c("No festivo", "Festivo")

# Boxplot: Alquileres totales por día festivo
ggplot(bicicletas,
       aes(x = holiday, y = cnt, fill = holiday)) +
  geom_boxplot() +
  labs(x = "Día festivo", y = "Alquileres totales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Boxplot: Alquileres casuales por día festivo
ggplot(bicicletas,
       aes(x = holiday, y = casual, fill = holiday)) +
  geom_boxplot() +
  labs(x = "Día festivo", y = "Alquileres casuales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Boxplot: Alquileres registrados por día festivo
ggplot(bicicletas,
       aes(x = holiday, y = registered, fill = holiday)) +
  geom_boxplot() +
  labs(x = "Día festivo", y = "Alquileres registrados") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

```
##Boxplot por día trabajado

(Agregar info)

```{r}
# Factor para día laboral (0/1 -> No laboral / Laboral)
bicicletas$workingday <- as.factor(bicicletas$workingday)
levels(bicicletas$workingday) <- c("No laboral", "Laboral")

# Boxplot: Alquileres totales por día laboral
ggplot(bicicletas,
       aes(x = workingday, y = cnt, fill = workingday)) +
  geom_boxplot() +
  labs(x = "Día laboral", y = "Alquileres totales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Boxplot: Alquileres casuales por día laboral
ggplot(bicicletas,
       aes(x = workingday, y = casual, fill = workingday)) +
  geom_boxplot() +
  labs(x = "Día laboral", y = "Alquileres casuales") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

# Boxplot: Alquileres registrados por día laboral
ggplot(bicicletas,
       aes(x = workingday, y = registered, fill = workingday)) +
  geom_boxplot() +
  labs(x = "Día laboral", y = "Alquileres registrados") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = paleta_colores)

```

```{r boxplots_continuos}
variables_cont <- c("temp", "atemp", "hum", "windspeed")

for (i in variables_cont) {
  print(
    ggplot(bicicletas, aes(x = "", y = .data[[i]], fill = i)) +
      geom_boxplot() +
      labs(title = paste("Distribución de", i),
           x = NULL, y = "Valor") +
      theme_minimal() +
      theme(legend.position = "none") +
      scale_fill_manual(values = paleta_colores)
  )
}

```

## Series de tiempo

Se grafica las series de tiempo de las variables coherentes: no se grafican ni variables categoricas ni variables redundantes como el dia de la semana.  

```{r series_de_tiempo}
#Temperatura
ggplot(bicicletas, aes(x = dteday, y = temp)) +
  geom_line(color = paleta_colores[1], linewidth = 1) +
  labs(x = "Fecha", y = "Temperatura") +
  theme_minimal()

#Temperatura percibida
ggplot(bicicletas, aes(x = dteday, y = atemp)) +
  geom_line(color = paleta_colores[3], linewidth = 1) +
  labs(x = "Fecha", y = "Sensación de temperatura") +
  theme_minimal()

#Humedad
ggplot(bicicletas, aes(x = dteday, y = hum)) +
  geom_line(color = paleta_colores[5], linewidth = 1) +
  labs(x = "Fecha", y = "Humedad") +
  theme_minimal()

#Velocidad del viento
ggplot(bicicletas, aes(x = dteday, y = windspeed)) +
  geom_line(color = paleta_colores[7], linewidth = 1) +
  labs(x = "Fecha", y = "Velocidad del viento") +
  theme_minimal()

#Casual y registererd
ggplot() +
  geom_line(data = bicicletas, aes(x = dteday, y = casual, color = "Alquileres casuales"), linewidth = 1) +
  geom_line(data = bicicletas, aes(x = dteday, y = registered, color = "Alquileres registrados"), linewidth = 1) +
  scale_color_manual(values = c("Alquileres casuales" = paleta_colores[8],
                                "Alquileres registrados" = paleta_colores[11])) +
  labs(x = "Fecha", y = "Cantidad",
       color = "Variable") +
  theme_minimal()

#Alquileres totales
ggplot(bicicletas, aes(x = dteday, y = cnt)) +
  geom_line(color = paleta_colores[2], linewidth = 1) +
  labs(x = "Fecha", y = "Bicicletas alquiladas") +
  theme_minimal()
```


## ACF

Para esta sección se calculan los respectivos ACF de cada variable, tomando un lag de un mes para su visualización y posible interpretación:

```{r}
acf(bicicletas$temp, lag.max = 31, main = "ACF - Temperatura (1 mes)")
```
Como los datos son diarios, entonces se toma un rezago de 31 días, con el fin de simular un mes de lag. Seguidamente, se debe observar que hay una fuerte correlación y además, ésta es significativa. Lo que sugiere que la temperatura de hoy está fuertemente relacionada a la temperatura de ayer. Lo cual tiene sentido, pues las temperaturas tienden a mantenerse constantes en una misma estación del año. Se nota además un comportamiento persistente, no hay oscilaciones. 

Analizando por otro lado la temperatura percibida:

```{r}
acf(bicicletas$atemp, lag.max = 31, main = "ACF - Temperatura percibida (1 mes)")
```
No se observa un cambio significativo en relación de la variable anterior, lo que sugiere el mismo patrón de análisis.

```{r}
acf(bicicletas$hum, lag.max = 31, main = "ACF - Humedad (1 mes)")
```
Del gráfico anterior se puede inferir entonces que la variable humedad no tiene una memoria de largo plazo, pues al cabo de 2 o 3 días hay un rápido decaimiento del ACF, lo que indica que la humedad de hoy depende hasta cierto de la variable de ayer. Sin embargo, las condiciones de humedad si pueden cambiar de manera significativa con respecto a los días. 

```{r}
acf(bicicletas$windspeed, lag.max = 31, main = "ACF - Velocidad del viento (1 mes)")
```
Note que en relación a la variable Velocidad del Viento se comporta de manera similar a la humedad, lo que sugiere un comportamiento de memoria corta, es decir, que no hay tanta relación de la velocidad del viento hoy con la velocidad del viento de ayer. 

```{r}
acf(bicicletas$casual, lag.max = 31, main = "ACF - Alquileres casuales (1 mes)")
```
La variable de Alquileres casuales es de sumo interés, pues note que hay una regularidad en el patrón, lo que sugiere que las personas tienden a alquilar más la bicicletas, cada cierto tiempo. Esto tiene sentido, pues las personas que alquilan bicicletas de manera casual lo harán con mayor probabilidad los findes de semana, implicando de esta forma que existe una estacionalidad semanal, es decir, un comportamiento similar a través del tiempo. 

Por último se analiza la variable de alquileres totales: 

```{r}
acf(bicicletas$cnt, lag.max = 31, main = "ACF - Alquileres totales (1 mes)")
```
Note que es un proceso de memoria larga, es decir, que la cantidad de bicicletas totales que se alquilaron hoy, dependen fuertemente de la cantidad de bicicletas que se alquilaron el día de ayer. 


Para las variables que presentaron mucha correlación se aplica entonces la primer diferencia, con tal de observar el comportamiento: 


```{r}
acf(diff(bicicletas$temp), lag.max = 31, main = "ACF - Temperatura diferenciada (1 mes)")
```

se observa entonces una disminución en la correlación existente. Se aplica el mismo razonamiento a las otras variables: 

```{r}
acf(diff(bicicletas$atemp), lag.max = 31, main = "ACF - Sensación térmica diferenciada (1 mes)")
```
Al aplicar la primer diferencia se elimina el comportamiento persistente, lo que sugiere que las diferencias siguen un comportamiento ciclico y unas correlaciones bajas.

```{r}
acf(diff(bicicletas$cnt), lag.max = 31, main = "ACF - Alquileres totales diferenciados (1 mes)")
```
La correlación negativa indica que el número de bicicletas de hoy, afecta de manera inversa al alquiler de bicicleta del día de mañana. Se logra eliminar la tendencia gracias a la diferenciación. Se elimina la memoria temporal fuerte existente. 


## CCF

A

## Coherencia

A

## Sobredispersión

A

## Periodogramas

Para hacer un análisis de las frecuencias que pueden existir en las diversas variables, se procede con algunos periodogramas.

```{r periodogramas}
# Se grafica el periodograma del conteo de la temperatura
temp_bicis <- mvspec(
  ts(
    bicicletas$temp,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = temp_bicis$freq,
           spec = temp_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la sensación térmica
atemp_bicis <- mvspec(
  ts(
    bicicletas$atemp,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = atemp_bicis$freq,
           spec = atemp_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la humedad
hum_bicis <- mvspec(
  ts(
    bicicletas$hum,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = hum_bicis$freq,
           spec = hum_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de la velocidad del viento
viento_bicis <- mvspec(
  ts(
    bicicletas$windspeed,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = viento_bicis$freq,
           spec = viento_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas
conteo_bicis <- mvspec(
  ts(
    bicicletas$cnt,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = conteo_bicis$freq,
           spec = conteo_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas casuales
casual_bicis <- mvspec(
  ts(
    bicicletas$casual,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = casual_bicis$freq,
           spec = casual_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  geom_vline(
    xintercept = 52,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    xintercept = 104,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "text",
    x = 52,
    y = 22500,
    label = "Frecuencia = 52",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  annotate(
    "text",
    x = 104,
    y = 6000,
    label = "Frecuencia = 104",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)

# Se grafica el periodograma del conteo de bicicletas registradas
registro_bicis <- mvspec(
  ts(
    bicicletas$registered,
    start = c(2011, 1, 1),
    frequency = 365
  ),
  kernel = kernel("modified.daniell", c(3, 3)),
  taper = .1,
  log = "yes",
  main = "",
  plot = FALSE
)

# Se pasa el espectro a ggplot
data.frame(freq = registro_bicis$freq,
           spec = registro_bicis$spec) %>%
  ggplot(aes(x = freq, y = spec)) +
  geom_line(color = paleta_colores[6], linewidth = 1) +
  geom_vline(
    xintercept = 52,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  geom_vline(
    xintercept = 104,
    color = paleta_colores[3],
    linetype = "dashed",
    linewidth = 1
  ) +
  annotate(
    "text",
    x = 52,
    y = 30000,
    label = "Frecuencia = 52",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  annotate(
    "text",
    x = 104,
    y = 6000,
    label = "Frecuencia = 104",
    color = paleta_colores[3],
    hjust = -0.1,
    size = 4
  ) +
  labs(x = "Frecuencia (diaria)",
       y = "Espectro (escala logarítmica)") +
  theme_minimal(base_size = 14)
```
